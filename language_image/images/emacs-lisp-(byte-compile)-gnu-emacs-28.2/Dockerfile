# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

# Install Emacs
sudo apt-get update
sudo apt-get install -y autoconf build-essential libgccjit-12-dev libgnutls28-dev libtinfo-dev pkg-config texinfo wget zlib1g-dev
cd /tmp
wget https://ftp.gnu.org/gnu/emacs/emacs-28.2.tar.gz
tar xvf emacs-28.2.tar.gz
cd emacs-28.2
./configure --with-native-compilation
make bootstrap NATIVE_FULL_AOT=1
sudo make install
# Install libraries
emacs --batch --eval "\
(progn
  (package-initialize)
  (add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)
  (package-refresh-contents)
  (mapc #'package-install
        '(dash
          ht
          recur
          s)))"
emacs --batch --eval "(package-initialize)" -f batch-byte-compile ~/.emacs.d/elpa/**/*.el

EOF



COPY --chmod=777 run.bash /tmp/run.bash

# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

sudo apt-get update
sudo apt-get install -y build-essential curl libffi-dev libffi8ubuntu1 libgmp-dev libgmp10 libncurses-dev libncurses5 libtinfo5 llvm-13 git
curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | env BOOTSTRAP_HASKELL_NONINTERACTIVE=1 BOOTSTRAP_HASKELL_GHC_VERSION=8.10.7 BOOTSTRAP_HASKELL_INSTALL_NO_STACK=1 sh
git clone https://github.com/darrenks/nibbles.git .
git config --global --add safe.directory /judge
git checkout 2e6c9dd77fafd1b15273c29b16062804b1fa07c9
~/.ghcup/bin/ghcup run --ghc 8.10.7 --cabal latest --install -- cabal install --lib dlist split murmur-hash memoize ghc base template-haskell containers bytestring process filepath
~/.ghcup/bin/ghcup run --ghc 8.10.7 -- ghc -O2 *.hs

EOF



COPY --chmod=777 run.bash /tmp/run.bash

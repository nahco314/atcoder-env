# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

# パッケージリポジトリの設定
wget -q https://packages.microsoft.com/config/ubuntu/22.10/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
rm packages-microsoft-prod.deb
sudo sh -c "cat > /etc/apt/preferences.d/dotnet <<'_eof_'
Package: dotnet*
Pin: origin packages.microsoft.com
Pin-Priority: 1001
_eof_"
sudo sh -c "cat > /etc/apt/preferences.d/aspnet <<'_eof_'
Package: aspnet*
Pin: origin packages.microsoft.com
Pin-Priority: 1001
_eof_"

# SDK のインストール
sudo apt-get update && sudo apt-get install -y dotnet-sdk-7.0=7.0.304-1

# カレントディレクトリーにプロジェクトファイルを設置
cat > Main.fsproj << EOS
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net7.0</TargetFramework>
    <DefineConstants>ONLINE_JUDGE;ATCODER</DefineConstants>
    <RuntimeIdentifier>ubuntu-x64</RuntimeIdentifier>
    <PublishReadyToRun>true</PublishReadyToRun>
    <SatelliteResourceLanguages>en-US</SatelliteResourceLanguages>
    <InvariantGlobalization>true</InvariantGlobalization>
  </PropertyGroup>
  <ItemGroup>
    <Compile Include="Main.fs" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="ac-library-csharp" Version="3.0.0-atcoder8" />
    <PackageReference Include="MathNet.Numerics" Version="5.0.0" />
    <PackageReference Include="MathNet.Numerics.FSharp" Version="5.0.0" />
    <PackageReference Include="Microsoft.ML" Version="2.0.1" />
    <PackageReference Include="Microsoft.ML.LightGbm" Version="2.0.1" />
  </ItemGroup>
</Project>
EOS

# プロジェクトをリストア。あらかじめコンパイルを通してWJの短縮を試みる
echo 'stdout.WriteLine "Hello, world!"' > Main.fs
export DOTNET_EnableWriteXorExecute=0
dotnet publish -c Release -o tmp -v q --nologo 1>&2
rm Main.fs

EOF



COPY --chmod=777 run.bash /tmp/run.bash

# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

# x86_64アーキテクチャを前提にしています

sudo apt update

# asdf

sudo apt install git curl git -y
git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.11.2
. "$HOME/.asdf/asdf.sh"
. "$HOME/.asdf/completions/asdf.bash"

# Erlang

sudo apt -y install build-essential autoconf m4 libncurses5-dev libwxgtk3.0-gtk3-dev libgl1-mesa-dev libglu1-mesa-dev libpng-dev libssh-dev unixodbc-dev xsltproc fop libxml2-utils libncurses-dev openjdk-11-jdk libwxgtk-webview3.0-gtk3-dev erlang-dev erlang-xmerl erlang-parsetools erlang-os-mon inotify-tools

## ここでサービスを再起動するように言われるかもしれない

asdf plugin-add erlang https://github.com/asdf-vm/asdf-erlang.git
asdf install erlang 26.0.2
asdf global erlang 26.0.2
# Elixir

sudo apt install -y unzip
pushd /tmp
wget https://github.com/elixir-lang/elixir/releases/download/v1.15.2/elixir-otp-26.zip
sudo unzip elixir-otp-26.zip -d /opt/elixir
popd
export PATH=/opt/elixir/bin:$PATH

# Setting up Elixir

mix local.hex --force
mix local.rebar --force

# Generate new project

mix new .
sed -e 's/# {:dep_from_hexpm, .*},/{:flow, "~> 1.2.4"}, {:nx, "~> 0.5.3"}, {:exla, "~> 0.5.3"},/'  -e 's/# {:dep_from_git, .*}//' -e 's/extra_applications: \[:logger\]/extra_applications: [:logger, :mnesia]/' mix.exs > mix.exs.new
mv mix.exs.new mix.exs
mkdir config
echo "import Config" > config/config.exs
echo "config :nx, :default_backend, EXLA.Backend" >> config/config.exs
echo "config :logger, level: :error" >> config/config.exs
mix format
mix deps.get
mix compile
rm -fr _build/dev/lib/judge

EOF



COPY --chmod=777 run.bash /tmp/run.bash

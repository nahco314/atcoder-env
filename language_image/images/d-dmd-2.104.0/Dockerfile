# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

sudo apt update
sudo apt install -y --no-install-recommends curl build-essential ca-certificates libxml2

D_COMPLILER="dmd-2.104.0"
export DFLAGS="-O -release -boundscheck=off"
wget https://dlang.org/install.sh -O /tmp/install.sh
chmod +x /tmp/install.sh
/tmp/install.sh install ${D_COMPLILER} 

sudo ln -s $(/tmp/install.sh get-path ${D_COMPLILER}) /usr/local/bin/dmd
sudo ln -s $(/tmp/install.sh get-path --dub ${D_COMPLILER}) /usr/local/bin/dub

dub init -n
dub add mir
dub build
rm judge source/app.d

EOF



COPY --chmod=777 run.bash /tmp/run.bash

# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

pushd /tmp
sudo apt install -y build-essential
# sbcl を source から compile するには sbcl が必要
sudo apt install -y sbcl
SBCL_VERSION=2.3.6
wget --trust-server-names https://sourceforge.net/projects/sbcl/files/sbcl/$SBCL_VERSION/sbcl-$SBCL_VERSION-source.tar.bz2/download -O sbcl-$SBCL_VERSION-source.tar.bz2
tar xf sbcl-$SBCL_VERSION-source.tar.bz2
cd sbcl-$SBCL_VERSION
GNUMAKE=make sh make.sh
sudo sh install.sh
# apt で入れた sbcl は不要なので削除する
sudo apt --purge -y remove sbcl
# /usr/local/bin/sbcl としてインストールされるので、PATH に /usr/local/bin を追加"

# Install Libraries
cd /tmp
curl -O https://beta.quicklisp.org/quicklisp.lisp
echo '(quicklisp-quickstart:install)' | sbcl --load quicklisp.lisp
cat > dump.lisp << '_eof_'
(progn
  (let ((quicklisp-init (merge-pathnames "quicklisp/setup.lisp"
                                            (user-homedir-pathname))))
    (when (probe-file quicklisp-init)
      (load quicklisp-init)))

(sb-ext:save-lisp-and-die "sbcl" :executable t))
_eof_
sbcl --script dump.lisp
popd
cp -p /tmp/sbcl .
export SBCL_HOME=/usr/local/lib/sbcl
./sbcl --eval '(ql:quickload "fast-generic-functions")' --quit
./sbcl --eval '(ql:quickload "trivia")' --quit
./sbcl --eval '(ql:quickload "iterate")' --quit
./sbcl --eval '(ql:quickload "cl-ppcre")' --quit

EOF



COPY --chmod=777 run.bash /tmp/run.bash

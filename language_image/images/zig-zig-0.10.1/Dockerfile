# syntax=docker/dockerfile:1.4.1

# generated by dockerfile_gen.py

# DOCKER_BUILDKIT=1 docker build ...

FROM ubuntu:23.04

SHELL ["/bin/bash", "-c"]

RUN apt-get update

RUN apt install sudo adduser

RUN adduser runner && \
    echo '%runner ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
USER runner

RUN sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true

RUN sudo apt install -y wget unzip xz-utils curl

RUN sudo mkdir /judge --mode=777

WORKDIR /judge


RUN <<EOF

sudo apt install git -y
pushd /tmp
wget https://ziglang.org/download/0.10.1/zig-linux-x86_64-0.10.1.tar.xz
sudo tar -C /opt -xf zig-linux-x86_64-0.10.1.tar.xz
sudo ln -s /opt/zig-linux-x86_64-0.10.1/zig /usr/local/bin/zig
git clone https://github.com/mattnite/gyro.git
cd gyro
zig build -Drelease-safe
sudo cp zig-out/bin/gyro /usr/local/bin
popd

# Create Project
zig init-exe
sed -i -e 's/const mode = .*/const mode = std.builtin.Mode.ReleaseFast;/;s/addExecutable(.*/addExecutable("a.out", "Main.zig");/;/@import/aconst pkgs = @import("deps.zig").pkgs;' build.zig
sed -i -e '/addExecutable/a\ \ \ \ pkgs.addAllTo(exe);' build.zig

# Install Libraries
gyro add --src github --root zig-string.zig JakubSzark/zig-string
gyro add --src github --root ziter.zig Hejsil/ziter
gyro fetch

EOF



COPY --chmod=777 run.bash /tmp/run.bash
